# MQ Monitor API

## MQ Exporter for Prometheus monitoring

This repository contains Java Spring Boot, microservice code for a monitoring solution that exports queue manager metrics to a Prometheus data collection system.  It also contains example configuration files on how to run the monitoring program.

The monitor collects metrics from an IBM MQ v9, v8 or v7 queue manager.  The monitor, read events created by the queue manager for Accounting or Statistics and exposes a REST API to return Prometheus output or JSON outout.  Prometheus can be configured to call the exposed end-point at regular intervals to pull these metrics into its database, where they can be queried directly or used with dashboard applications such as Grafana.

The API can be run as a service or from a Docker container.

## Configure IBM MQ

The API can be run in three ways;

* Local binding connection
* Client connection
* Client Channel Definition Table connection

### Local Binding connections

When running with a local binding connection, the API and the queue manager must be running on the same host.  The API connects directly to the queue manager.  No security or authentication is required, as the API is deemed to be authenticated due to it running on the same host.

```
ibm.mq.queueManager: QMGR
ibm.mq.local: true
```

No additional queue manager properties are required, but the APIs common properties can still be used.

### Client Connections

When running as a client connection, the API and the queue manager run on seperate servers, the API connects to the queue manager over a network.  The queue manager must be configured to expose a running MQ listener, have a configured server-connection channel and the appropriate authorities set against the MQ objects (queue manager, queues, channels etc) to issue PCF commands.

Minimum yaml requirements in the application-XXXX.yaml file

```
ibm.mq.queueManager: QMGR
ibm.mq.channel: SVRCONN.CHANNEL.NAME
ibm.mq.connName: HOSTNAME(PORT)
ibm.mq.user: MQUser
ibm.mq.password: secret
ibm.mq.authenticateUsingCSP: true
ibm.mq.local: false
```

`ibm.mq.local` can be true of false, depending if the API connects to queue manager in local binding or client mode.


Connections to the queue manager should be encrypted where possible.  For this, the queue manager needs to be configured with a key-store / trust-store - which can be the same file - and the server-connection channel needs to be configured with a cipher.

```
ibm.mq.useSSL: true
ibm.mq.sslCipherSpec: TLS_RSA_WITH_AES_128_CBC_SHA256
ibm.mq.ibmCipherMapping: false 
ibm.mq.security.truststore: {fully qualified file path}/truststore 
ibm.mq.security.truststore-password: secret
ibm.mq.security.keystore: {fully qualified file path}/keystore 
ibm.mq.security.keystore-password: secret
```
> Keystore and Truststore must be JKS files.

`ibm.mq.useSSL` can be true of false, depending if the MQ server connection channel is configured to be SSL/TLS enabled.

`ibm.mq.ibmCipherMapping` can be true of false, depending on the JVM being used.

### Client Channel Definition Table (CCDT) connections

When running with a CCDT connection, this is similar to a client connection, with the client connection details stored in a secure, binary file.

```
ibm.mq.queueManager: QMGR
ibm.mq.channel: SVRCONN.CHANNEL.NAME   
ibm.mq.ccdtFile: {fully qualified file path}/AMQCLCHL.TAB 
```

All configurations are stored in the Spring Boot yaml or properties file, which it typically located in a `./config` folder under where the API jar file is run from.

## API Endpoints

By default the output of the API is in Prometheus format, but can also be returned in JSON format.

Currently, the API endpoints do not use HTTPS for clients - this will be added in future releases.

### Promtheus Output 

Invoking the API using the below URL, will generate a response in Prometheus format.

`http://{hostname}:{port}/actuator/prometheus`

### JSON Output 

Invoking the API using the below URL, will generate a response in JSON format.

`http://{hostname}:{port}/json/allmetrics` - Returns ALL metrics, including MQ metrics and System metrics generated by the API

`http://{hostname}:{port}/json/mqmetrics` - Returns only MQ metrics - these are all metrics prefixed `mq:`

JSON output can be sorted into Ascending or Descending order using the following properties.

`ibm.mq.json.sort:true|false` - The sort value can be true or false.  True sorts the JSON response into the required order.
`ibm.mq.json.order:ascending|descending` - The order in which to sort the JSON response. By default, the order is in ascending order.


## Events

Event messages are generated in [IBMs PCF](https://www.ibm.com/support/knowledgecenter/SSFKSJ_9.1.0/com.ibm.mq.adm.doc/q020000_.htm) format. 

The following MQ metrics are currently processed;

Accounting
------------

MQ Metric | Type | Description
----------| ---- | -----------
MQIAMO_OPENS | ACCOUNTING | Number of Open operations that have occurred on a queue
MQIAMO_CLOSES | ACCOUNTING | Number of Close operations that have occurred on a queue
MQIAMO_PUT_MAX_BYTES | ACCOUNTING | The maximum number of bytes written (PUT) to the queue
MQIAMO_GET_MAX_BYTES | ACCOUNTING | The maximum number of bytes read (GET) from the queue
MQIAMO_PUTS | ACCOUNTING | The number of writes (PUTS) to the queue
MQIAMO_GETS | ACCOUNTING | The number of reads (GETS) from the queue
MQIAMO_PUTS_FAILED | ACCOUNTING | The number of failed writes **
MQIAMO_GETS_FAILED | ACCOUNTING | The number of failed gets **

> Other ACCOUNTING metrics are available [here](https://www.ibm.com/support/knowledgecenter/SSFKSJ_9.1.0/com.ibm.mq.mon.doc/q037470_.htm) under `QAccountingData`

Statistics
----------

MQ Metric | Type | Description
----------| ---- | -----------
MQIAMO_PUTS | STATISTICS | The number of writes (PUTS) to the queue
MQIAMO_GETS | STATISTICS | The number of reads (GETS) from the queue


> Other STATISTICS metrics are available [here](https://www.ibm.com/support/knowledgecenter/SSFKSJ_9.1.0/com.ibm.mq.mon.doc/q037490_.htm) under `QStatisticsData`

Examples of Statistics output in Prometheus format
--------------------------------------------------

PUTs per year

```
# HELP mq:puts_per_year  
# TYPE mq:puts_per_year gauge
mq:puts_per_year{persistence="false",queueManagerName="QMAP01",queueName="IBM",year="2020",} 6.0
mq:puts_per_year{persistence="false",queueManagerName="QMAP01",queueName="CPU_SUMMARY",year="2020",} 840.0
mq:puts_per_year{persistence="false",queueManagerName="QMAP01",queueName="CPU_QMGR",year="2020",} 840.0
```

PUTs per month

```
# HELP mq:puts_per_month  
# TYPE mq:puts_per_month gauge
mq:puts_per_month{month="9",persistence="false",queueManagerName="QMAP01",queueName="IBM",year="2020",} 6.0
mq:puts_per_month{month="9",persistence="false",queueManagerName="QMAP01",queueName="CPU_SUMMARY",year="2020",} 840.0
mq:puts_per_month{month="9",persistence="false",queueManagerName="QMAP01",queueName="CPU_QMGR",year="2020",} 840.0
```

PUTs per day

```
# HELP mq:puts_per_day  
# TYPE mq:puts_per_day gauge
mq:puts_per_day{day="30",month="9",persistence="false",queueManagerName="QMAP01",queueName="CPU_SUMMARY",week="40",year="2020",} 840.0
mq:puts_per_day{day="30",month="9",persistence="false",queueManagerName="QMAP01",queueName="CPU_QMGR",week="40",year="2020",} 840.0
mq:puts_per_day{day="30",month="9",persistence="false",queueManagerName="QMAP01",queueName="IBM",week="40",year="2020",} 6.0
```

GETs per year

```
# HELP mq:gets_per_year  
# TYPE mq:gets_per_year gauge
mq:gets_per_year{persistence="false",queueManagerName="QMAP01",queueName="IBM",year="2020",} 6.0
```

GETs per month

```
# HELP mq:gets_per_month  
# TYPE mq:gets_per_month gauge
mq:gets_per_month{month="9",persistence="false",queueManagerName="QMAP01",queueName="IBM",year="2020",} 6.0
```

GETs per day

```
# HELP mq:gets_per_day  
# TYPE mq:gets_per_day gauge
mq:gets_per_day{day="30",month="9",persistence="false",queueManagerName="QMAP01",queueName="IBM",week="40",year="2020",} 6.0
```

Queue Manager status

```
# HELP mq:queueManagerStatus  
# TYPE mq:queueManagerStatus gauge
mq:queueManagerStatus{queueManagerName="QMAP01",} 2.0
```

Examples of Accounting output in Prometheus format
--------------------------------------------------

MAX GET Message Size

```
# HELP mq:queueMaxGetMsgSize  
# TYPE mq:queueMaxGetMsgSize gauge
mq:queueMaxGetMsgSize{queueManagerName="QMAP01",queueName="IBM",} 8.0
```

MAX PUT message size

```
# HELP mq:queueMaxPutMsgSize  
# TYPE mq:queueMaxPutMsgSize gauge
mq:queueMaxPutMsgSize{queueManagerName="QMAP01",queueName="IBM",} 8.0
```

PUTs per year

```
# HELP mq:puts_per_year  
# TYPE mq:puts_per_year gauge
mq:puts_per_year{persistence="false",queueManagerName="QMAP01",queueName="IBM",year="2020",} 6.0
```

PUTs per month

```
# HELP mq:puts_per_month  
# TYPE mq:puts_per_month gauge
mq:puts_per_month{month="9",persistence="false",queueManagerName="QMAP01",queueName="IBM",year="2020",} 6.0
```

PUTs per day

```
# HELP mq:puts_per_day  
# TYPE mq:puts_per_day gauge
mq:puts_per_day{day="30",month="9",persistence="false",queueManagerName="QMAP01",queueName="IBM",week="40",year="2020",} 6.0
```

GETs per year

```
# HELP mq:gets_per_year  
# TYPE mq:gets_per_year gauge
mq:gets_per_year{persistence="false",queueManagerName="QMAP01",queueName="IBM",year="2020",} 6.0
```

GETs per month

```
# HELP mq:gets_per_month  
# TYPE mq:gets_per_month gauge
mq:gets_per_month{month="9",persistence="false",queueManagerName="QMAP01",queueName="IBM",year="2020",} 6.0
```

GETS per day

```
# HELP mq:gets_per_day  
# TYPE mq:gets_per_day gauge
mq:gets_per_day{day="30",month="9",persistence="false",queueManagerName="QMAP01",queueName="IBM",week="40",year="2020",} 6.0
```

OPENs per year

```
# HELP mq:opens_per_year  
# TYPE mq:opens_per_year gauge
mq:opens_per_year{queueManagerName="QMAP01",queueName="IBM",year="2020",} 7.0
```

OPENs per month

```
# HELP mq:opens_per_month  
# TYPE mq:opens_per_month gauge
mq:opens_per_month{month="9",queueManagerName="QMAP01",queueName="IBM",year="2020",} 7.0
```

OPENs per day

```
# HELP mq:opens_per_day  
# TYPE mq:opens_per_day gauge
mq:opens_per_day{day="30",month="9",queueManagerName="QMAP01",queueName="IBM",week="40",year="2020",} 7.0
```

CLOSEs per year

```
# HELP mq:closes_per_year  
# TYPE mq:closes_per_year gauge
mq:closes_per_year{queueManagerName="QMAP01",queueName="IBM",year="2020",} 7.0
```

CLOSEs per month

```
# HELP mq:closes_per_month  
# TYPE mq:closes_per_month gauge
mq:closes_per_month{month="9",queueManagerName="QMAP01",queueName="IBM",year="2020",} 7.0
```

CLOSEs per day

```
# HELP mq:closes_per_day  
# TYPE mq:closes_per_day gauge
mq:closes_per_day{day="30",month="9",queueManagerName="QMAP01",queueName="IBM",week="40",year="2020",} 7.0
```

Queue Manager status

```
# HELP mq:queueManagerStatus  
# TYPE mq:queueManagerStatus gauge
mq:queueManagerStatus{queueManagerName="QMAP01",} 2.0
```

GET fails

```
# HELP mq:get_fails  
# TYPE mq:get_fails gauge
mq:get_fails{queueManagerName="QMAP01",queueName="IBM",} 1.0
```





